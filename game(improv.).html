<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Echo Maze — Neon Escape</title>
<style>
:root{--bg:#05050a;--cyan:#00ffff;}
html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#eaf0ff;overflow:hidden}
canvas{display:block;border-radius:14px;box-shadow:0 10px 60px rgba(0,0,0,0.6);margin:auto;position:absolute;left:0;right:0;top:0;bottom:0}
#overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:5;transition:opacity 0.5s ease}
#panel{background:rgba(2,8,15,0.95);padding:22px;border-radius:14px;text-align:center;max-width:500px;line-height:1.5;animation:fadeIn 0.6s}
#panel h1{margin:0 0 12px;font-size:28px;color:var(--cyan)}
#panel p{margin:8px 0;}
#startBtn, .optionBtn{margin-top:16px;padding:12px 20px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--cyan),#00dda0);color:#002;font-weight:700;cursor:pointer;transition:transform 0.2s;}
#startBtn:hover, .optionBtn:hover{transform:scale(1.1);}
#hud{position:absolute;top:14px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.45);padding:6px 12px;border-radius:10px;font-size:15px;color:var(--cyan);z-index:4}
#controls{position:absolute;right:14px;bottom:14px;display:flex;flex-direction:column;gap:8px;z-index:4}
.btn{background:rgba(255,255,255,0.06);border:1px solid rgba(0,255,255,0.06);color:var(--cyan);padding:8px 10px;border-radius:8px;cursor:pointer}
.small{font-size:13px;padding:6px 8px}

#mobileControls{position:absolute;left:14px;bottom:14px;display:flex;flex-direction:column;gap:6px;z-index:4;}
#mobileControls div{display:flex;justify-content:center;gap:6px;}

@keyframes fadeIn { from {opacity:0; transform:scale(0.8);} to {opacity:1; transform:scale(1);} }
</style>
</head>
<body>
<canvas id="game"></canvas>

<div id="overlay">
  <div id="panel">
    <h1>Echo Maze — Neon Escape</h1>
    <p><b>PC Controls:</b><br>• Move: W/A/S/D or Arrow keys<br>• Ping sonar: Space or Click</p>
    <p><b>Phone Controls:</b><br>• Use buttons below to move<br>• Tap Ping button</p>
    <p><b>Power-Ups:</b><br>
      • Cyan: +3 Echoes<br>• Yellow: Shield<br>• Green: +120 Score</p>
    <button id="startBtn">Start Game</button>
  </div>
</div>

<div id="hud"></div>
<div id="controls">
  <button id="toggleMusic" class="btn small">Toggle Music</button>
  <div style="display:flex;gap:6px;">
    <button id="volDown" class="btn small">Vol -</button>
    <button id="volUp" class="btn small">Vol +</button>
  </div>
</div>

<!-- MOBILE BUTTON CONTROLS -->
<div id="mobileControls">
  <div><button class="btn small" id="upBtn">↑</button></div>
  <div>
    <button class="btn small" id="leftBtn">←</button>
    <button class="btn small" id="downBtn">↓</button>
    <button class="btn small" id="rightBtn">→</button>
  </div>
  <div><button class="btn small" id="pingBtn">Ping</button></div>
</div>

<audio id="bg" loop preload="auto">
  <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
</audio>
<audio id="levelUp" preload="auto">
  <source src="https://freesound.org/data/previews/569/569564_10298817-lq.mp3" type="audio/mpeg">
</audio>

<script>
/* --- GLOBALS --- */
const canvas = document.getElementById('game'), ctx = canvas.getContext('2d');
function resize(){ canvas.width=Math.max(900,Math.min(window.innerWidth-40,1200)); canvas.height=Math.max(600,Math.min(window.innerHeight-40,800));}
resize(); window.addEventListener('resize',resize);

let running=false, keys={}, tiltX=0, tiltY=0, maze=[], powerUps=[], sonar=[];
let player={x:50,y:50,r:10,speed:170,shield:false,hitCD:0}, echoes=10, lives=3, level=1, score=0, exitPulse=0;
let levelTransition=false;

const hud=document.getElementById('hud'), overlay=document.getElementById('overlay');
const bg=document.getElementById('bg'), levelUp=document.getElementById('levelUp'); bg.volume=0.12; levelUp.volume=0.3;

/* --- AUDIO CONTROLS --- */
document.getElementById('toggleMusic').onclick=()=>{ if(bg.paused) bg.play(); else bg.pause(); };
document.getElementById('volDown').onclick=()=>{ bg.volume=Math.max(0,(bg.volume-0.05).toFixed(2)); };
document.getElementById('volUp').onclick=()=>{ bg.volume=Math.min(1,(bg.volume+0.05).toFixed(2)); };

/* --- MAZE --- */
let cell=48, cols=0, rows=0;
function generateMaze(){
  cell=Math.max(36,Math.floor(Math.min(canvas.width/18,canvas.height/12)));
  cols=Math.floor(canvas.width/cell); rows=Math.floor(canvas.height/cell);
  let grid=Array(rows*cols).fill(1), startR=1,startC=1;
  const inBounds=(r,c)=>r>=0&&r<rows&&c>=0&&c<cols;
  const stack=[{r:startR,c:startC}]; grid[startR*cols+startC]=0;
  const dirs=[{dr:0,dc:2},{dr:2,dc:0},{dr:0,dc:-2},{dr:-2,dc:0}];
  while(stack.length){
    const cur=stack[stack.length-1];
    const nbs=dirs.map(d=>({r:cur.r+d.dr,c:cur.c+d.dc})).filter(n=>inBounds(n.r,n.c)&&grid[n.r*cols+n.c]===1);
    if(nbs.length){
      const next=nbs[Math.floor(Math.random()*nbs.length)];
      const midR=(cur.r+next.r)/2, midC=(cur.c+next.c)/2;
      grid[next.r*cols+next.c]=0; grid[midR*cols+midC]=0; stack.push(next);
    } else stack.pop();
  }
  maze=[]; for(let r=0;r<rows;r++){ for(let c=0;c<cols;c++){ if(grid[r*cols+c]===1) maze.push({x:c*cell,y:r*cell,w:cell,h:cell,glow:0}); }}
  player.x=cell+cell/2; player.y=cell+cell/2;
}

/* --- POWERUPS --- */
function spawnPowerUps(){
  powerUps=[]; for(let i=0;i<6;i++){
    let px,py,tries=0;
    do { px=Math.random()*(canvas.width-80)+40; py=Math.random()*(canvas.height-80)+40; tries++; if(tries>120) break; } 
    while(maze.some(w=>px>w.x&&px<w.x+w.w&&py>w.y&&py<w.y+w.h));
    powerUps.push({x:px,y:py,r:10,type:i%3===0?'echo':i%3===1?'shield':'score',active:true});
  }
}

/* --- SONAR --- */
function ping(){ if(echoes<=0) return; sonar.push({x:player.x,y:player.y,r:20,max:Math.min(canvas.width,canvas.height)*0.45}); echoes--; }

/* --- RESET --- */
function resetAll(levelReset=false){
  generateMaze(); spawnPowerUps(); sonar=[]; if(levelReset){ echoes=10; lives=3; score=0; level=1;}
  player.shield=false; exitPulse=0; last=0; levelTransition=false;
}

/* --- OVERLAY --- */
function showOverlay(title){
  overlay.innerHTML=`<div id="panel">
    <h1>${title}</h1>
    <p>Score: ${score} • Level: ${level}</p>
    <button class="optionBtn" id="nextBtn">${title==='Game Over'?'Play Again':'Next Level'}</button>
  </div>`;
  overlay.style.display='flex';
  document.getElementById('nextBtn').onclick=()=>{
    overlay.style.display='none';
    running=true;
    if(title==='Game Over'){ resetAll(true); } else { generateMaze(); spawnPowerUps(); player.x=cell+cell/2; player.y=cell+cell/2; echoes=10; }
    requestAnimationFrame(loop);
  };
}

/* --- UPDATE --- */
let last=0;
function update(dt){
  if(levelTransition) return;

  player.hitCD=Math.max(0,player.hitCD-dt);
  let dx=(keys.ArrowRight||keys.d?1:0)-(keys.ArrowLeft||keys.a?1:0);
  let dy=(keys.ArrowDown||keys.s?1:0)-(keys.ArrowUp||keys.w?1:0);
  dx+=tiltX*0.6; dy+=tiltY*0.6;
  if(dx!==0||dy!==0){ let len=Math.hypot(dx,dy); dx/=len; dy/=len; player.x+=dx*player.speed*dt; player.y+=dy*player.speed*dt; }
  player.x=Math.max(player.r+2,Math.min(canvas.width-player.r-2,player.x));
  player.y=Math.max(player.r+2,Math.min(canvas.height-player.r-2,player.y));

  for(const w of maze){
    if(player.x+player.r>w.x&&player.x-player.r<w.x+w.w&&player.y+player.r>w.y&&player.y-player.r<w.y+w.h){
      if(player.hitCD<=0){ 
        if(player.shield){player.shield=false; w.glow=1;} 
        else { lives--; echoes=10; player.hitCD=0.6; player.x=cell+cell/2; player.y=cell+cell/2; }
      }
    }
  }

  for(const p of powerUps){ if(p.active&&Math.hypot(player.x-p.x,player.y-p.y)<player.r+p.r+2){ p.active=false; if(p.type==='echo') echoes=Math.min(echoes+3,9); if(p.type==='shield') player.shield=true; if(p.type==='score') score+=120; } }

  for(const s of sonar){ s.r+=200*dt; }
  for(let i=sonar.length-1;i>=0;i--) if(sonar[i].r>sonar[i].max) sonar.splice(i,1);

  exitPulse+=dt; const ex={x:canvas.width-80,y:canvas.height-80,r:26};
  if(Math.hypot(player.x-ex.x,player.y-ex.y)<ex.r){
    level++; score+=200; echoes=10;
    levelTransition=true;
    levelUp.play().catch(()=>{});
    setTimeout(()=>{ showOverlay('Level Completed'); },300);
  }

  if(lives<=0&&running){ running=false; showOverlay('Game Over'); }
}

/* --- DRAW --- */
function draw(){
  ctx.fillStyle='#05050a'; ctx.fillRect(0,0,canvas.width,canvas.height);

  const ex={x:canvas.width-80,y:canvas.height-80}; const pulse=28+Math.sin(exitPulse*5)*12;
  const eg=ctx.createRadialGradient(ex.x,ex.y,0,ex.x,ex.y,pulse); eg.addColorStop(0,'rgba(0,255,180,1)'); eg.addColorStop(0.4,'rgba(0,255,180,0.5)'); eg.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=eg; ctx.beginPath(); ctx.arc(ex.x,ex.y,pulse,0,Math.PI*2); ctx.fill();

  for(const s of sonar){ const g=ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,s.r); g.addColorStop(0,'rgba(0,255,255,0.45)'); g.addColorStop(0.5,'rgba(0,200,255,0.2)'); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill(); }

  for(const w of maze){ let visible=false; for(const s of sonar){ const cx=w.x+w.w/2,cy=w.y+w.h/2; if(Math.hypot(cx-s.x,cy-s.y)<s.r+50){ visible=true; break; } } if(w.glow>0) visible=true; if(visible){ ctx.fillStyle='rgba(0,255,255,0.45)'; ctx.fillRect(w.x,w.y,w.w,w.h); } }

  for(const p of powerUps){ if(!p.active) continue; const g=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r+12); if(p.type==='echo'){g.addColorStop(0,'rgba(0,255,255,0.5)'); g.addColorStop(1,'rgba(0,255,255,0)');} else if(p.type==='shield'){g.addColorStop(0,'rgba(255,255,0,0.45)'); g.addColorStop(1,'rgba(255,255,0,0)');} else{g.addColorStop(0,'rgba(0,255,120,0.45)'); g.addColorStop(1,'rgba(0,255,120,0)');} ctx.fillStyle=g; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); }

  ctx.beginPath(); ctx.arc(player.x,player.y,player.r,0,Math.PI*2); ctx.fillStyle=player.shield?'#ffd042':'#ffffff'; ctx.fill();
  hud.innerHTML=`Level: ${level} • Score: ${score} • Echoes: ${echoes} • Lives: ${lives}`;
}

/* --- LOOP --- */
function loop(ts){ if(!running) return; if(!last) last=ts; const dt=Math.min(0.05,(ts-last)/1000); last=ts; update(dt); draw(); requestAnimationFrame(loop); }

/* --- INPUT --- */
window.addEventListener('keydown',e=>{ keys[e.key]=true; if(e.key===' ') ping(); });
window.addEventListener('keyup',e=>{ keys[e.key]=false; });
canvas.addEventListener('click',()=>{ if(running) ping(); });

/* --- MOBILE BUTTONS --- */
tiltX = 0; tiltY = 0;
const upBtn = document.getElementById('upBtn');
const downBtn = document.getElementById('downBtn');
const leftBtn = document.getElementById('leftBtn');
const rightBtn = document.getElementById('rightBtn');
const pingBtn = document.getElementById('pingBtn');

function updateTilt(){
  tiltX = 0;
  tiltY = 0;
  if(upBtn.pressed) tiltY -= 1;
  if(downBtn.pressed) tiltY += 1;
  if(leftBtn.pressed) tiltX -= 1;
  if(rightBtn.pressed) tiltX += 1;
}

[upBtn, downBtn, leftBtn, rightBtn].forEach(btn=>{
  btn.pressed = false;
  btn.addEventListener('pointerdown',()=>{ btn.pressed=true; updateTilt(); });
  btn.addEventListener('pointerup',()=>{ btn.pressed=false; updateTilt(); });
  btn.addEventListener('pointerleave',()=>{ btn.pressed=false; updateTilt(); });
});

pingBtn.addEventListener('pointerdown',()=>{ ping(); });

/* --- START --- */
document.getElementById('startBtn').onclick=()=>{ overlay.style.display='none'; resetAll(true); running=true; if(!bg.paused) bg.play().catch(()=>{}); requestAnimationFrame(loop); }
</script>
</body>
</html>
